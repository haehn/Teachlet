<html>
  <head>
    <title>Harvard TEACHLET</title>
    <style id="gallery" >
      .block {
        display: inline-block;
        padding: 20px;
        font-size: 0.8em;
      }
      h5 {
        display: none;
      }
</style>
</head>
<body>

<body style='font-family: sans-serif; font-size: 20pt;'>
 <div><img src='logo.jpg'></div>
 <div style='padding:20px'>Hi TF! This will help you memorize the names of your section students.</div>
 <div><img src='1.png' style='vertical-align:middle'><span>Drag this bookmarklet <a href='' id='bookmarklet' alt='Teachlet' title='Teachlet'><img src='bookmark.png' width=50 alt='Teachlet'></a> to your bookmarks!</span></div>
 <div><img src='2.png' style='vertical-align:middle'><span>Login to <a href="https://connections.harvard.edu/" target="_blank">Harvard Connections</a>.</span></div>
 <div><img src='3.png' style='vertical-align:middle'><span>Click on the bookmarklet <img src='bookmarklet.png' style='vertical-align:middle'></span></div>



<script>

function grab_pics() {
  var cssCode = "ENTER_HERE";

  var input = prompt('Provide a list of students');
  input = input.split('\n');

  var names = input.map(function(line) {
    var name = line.trim();
    var t = name.split(',');
    return {
      name: name,
      search: t[1].trim() + " " + t[0].trim()
    }; 
  });

  var images = [];

  function done() {
    //replace body
    images = images.sort(function(a, b) {
      return a.name.localeCompare(b.name);
    });
    $('<style/>').appendTo('head').innerText = cssCode;
    
    document.body.innerHTML = '<div></div>';

    var $div = $('div');
    images.forEach(function(row) {
      $('<div class="block"/>').appendTo($div).html(row.code);
    });
  }

  var parser=new DOMParser();

  names.forEach(function(name) {
    console.log('grab',name.name);
    $.get("https://connections.harvard.edu/search/pageNum/0/resultsPerPage/1?name="+name.search,function(data){
      var xmlDoc=parser.parseFromString(data,"text/html"); 
      images.push({
        name: name.name,
        code: ($('#compressedUser tr',xmlDoc).first().html()).replace('td','span') 
      });
      console.log('grabbed',name.name);
      if (images.length === names.length) {
        done();
      }
    });
  });
}

//inject code
var code = grab_pics.toString();
var css = document.getElementById('gallery').innerText.replace('\r\n','  ');
code = code.replace('ENTER_HERE', css);
code = code.replacde('\r\n', '  ');
document.getElementById('bookmarklet').href = 'javascript:(' + code+')()';

</script>

</body>
</html>

