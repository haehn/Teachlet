<html>
  <head>
    <title>Harvard TEACHLET</title>
    <style id="gallery" >
      .block {
        display: inline-block;
        padding: 20px;
        font-size: 0.8em;
      }
      h5 {
        display: none;
      }
</style>
</head>
<body>

<body style='font-family: sans-serif; font-size: 20pt;'>
 <div><img src='logo.jpg'></div>
 <div style='padding:20px'>Hi TF! This will help you memorize the names of your section students.</div>
 <div><img src='1.png' style='vertical-align:middle'><span>Drag this bookmarklet <a href='' id='bookmarklet' alt='Teachlet' title='Teachlet'><img src='bookmark.png' width=50 alt='Teachlet'></a> to your bookmarks!</span></div>
 <div><img src='2.png' style='vertical-align:middle'><span>Login to <a href="https://connections.harvard.edu/" target="_blank">Harvard Connections</a>.</span></div>
 <div><img src='3.png' style='vertical-align:middle'><span>Click on the bookmarklet <img src='bookmarklet.png' style='vertical-align:middle'></span></div>



<script>

function grab_pics() {
  var cssCode = "ENTER_HERE";

  function toNames(input) {
    input = input.split('\n');
    var names = input.map(function(line) {
      var name = line.trim();
      var t = name.split(',');
      return {
        name: name,
        search: t[1].trim() + " " + t[0].trim()
      }; 
    });
    return names; 
  }

  function grabAll(names, onDone) {
    var images = [];
    var parser=new DOMParser();
    names.forEach(function(name) {
      console.log('grab',name.name);
      $.get("https://connections.harvard.edu/search/pageNum/0/resultsPerPage/1?name="+name.search,function(data){
        var xmlDoc=parser.parseFromString(data,"text/html"); 
        images.push({
          name: name.name,
          code: $('#compressedUser tr',xmlDoc).first().html().replace('<td>','').replace('</td>','') 
        });
        console.log('grabbed',name.name);
        if (images.length === names.length) {
          onDone(names, images);
        }
      });
    })
  }

  function done(names, images) {  
    images = images.sort(function(a, b) {
      return a.name.localeCompare(b.name);
    });
    
    document.body.innerHTML = '<div></div>';

    var $div = $('div');
    images.forEach(function(row) {
      $('<div class="block"/>').appendTo($div).html(row.code);
    });
  }

  $('<style>').appendTo('head').text(cssCode);
  $('<form id="teachlet"><textarea placeholder="Copy List here"></textarea><button type="submit">Search</button></form>').appendTo('body').on('submit', function() {
    var names = $(this).find('textarea').val();
    names = toNames(names);
    grabAll(names, done);
    return false;
  });
}

//inject code
var code = grab_pics.toString();
var css = document.getElementById('gallery').innerText.replace('\r\n',' ');
code = code.replace('ENTER_HERE', css);
code = code.replace('\r\n', ' ').replace('  ',' ').replace('  ',' ').replace('  ',' ').replace('  ',' ');
document.getElementById('bookmarklet').href = 'javascript:(' + code +')()';

</script>

</body>
</html>

