<html>
<head>
<title>Directory Picture Extractor</title>

<style id="gallery" >
  .block {
    display: inline-block;
    padding: 20px;
    font-size: 0.8em;
  }
  h5 {
    display: none;
  }
</style>
</head>
<body>



<a href="" id="link">BOOKMARKLET</a>

<img src='hint.jpg'>

<script>

function grab_pics() {
  var cssCode = "ENTER_HERE";

  var input = prompt('Provide a list of students');
  input = input.split('\n');

  var names = input.map(function(line) {
    var name = line.trim();
    var t = name.split(',');
    return {
      name: name,
      search: t[1].trim() + " " + t[0].trim()
    }; 
  });

  var images = [];

  function done() {
    //replace body
    images = images.sort(function(a, b) {
      return a.name.localeCompare(b.name);
    });
    $('<style/>').appendTo('head').innerText = cssCode;
    
    document.body.innerHTML = '<div></div>';

    var $div = $('div');
    images.forEach(function(row) {
      $('<div class="block"/>').appendTo($div).html(row.code);
    });
  }

  var parser=new DOMParser();

  names.forEach(function(name) {
    console.log('grab',name.name);
    $.get("https://connections.harvard.edu/search/pageNum/0/resultsPerPage/1?name="+name.search,function(data){
      var xmlDoc=parser.parseFromString(data,"text/html"); 
      images.push({
        name: name.name,
        code: ($('#compressedUser tr',xmlDoc).first().html()).replace('td','span') 
      });
      console.log('grabbed',name.name);
      if (images.length === names.length) {
        done();
      }
    });
  });
}

//inject code
var code = grab_pics.toString();
var css = document.getElementById('gallery').innerText.replace('\r\n','  ');
code = code.replace('ENTER_HERE', css);
code = code.replacde('\r\n', '  ');
document.getElementById('link').href = 'javascript:(' + code+')()';

</script>

</body>
</html>

