<html>
  <head>
    <title>Harvard TEACHLET</title>
    <style id="gallery" >
      .block {
        display: inline-block;
        padding: 20px;
        font-size: 0.8em;
      }
      h5 {
        display: none;
      }
      #teachlet {
        position: absolute;
        left: 40%;
        padding: 20px;
        top: 20%;
        background: cornflowerblue;
        border: solid thin black;        
      }
</style>
</head>
<body>

<body style='font-family: sans-serif; font-size: 20pt;'>
 <div><img src='logo.jpg'></div>
 <div style='padding:20px'>Hi TF! This will help you memorize the names of your section students.</div>
 <div><img src='1.png' style='vertical-align:middle'><span>Drag this bookmarklet <a href='' id='bookmarklet' alt='Teachlet' title='Teachlet'><img src='bookmark.png' width=50 alt='Teachlet'></a> to your bookmarks!</span></div>
 <div><img src='2.png' style='vertical-align:middle'><span>Login to <a href="https://connections.harvard.edu/" target="_blank">Harvard Connections</a>.</span></div>
 <div><img src='3.png' style='vertical-align:middle'><span>Click on the bookmarklet <img src='bookmarklet.png' style='vertical-align:middle'></span></div>

 <div id="gallerytext" style='display: none'>
  <div></div>
 </div>
<script>

function grab_pics() {
  var cssCode = "ENTER_HERE";
  var htmlCode = "ENTER_HTML";

  function toNames(input) {
    input = input.split('\n');
    var names = input.map(function(line) {
      var name = line.trim();
      var t = name.split(',');
      return {
        name: name,
        search: t.length < 2 ? t[0].trim() : t[1].trim() + " " + t[0].trim()
      }; 
    });
    return names.filter(function(name) {
      return name.name.trim().length > 0
    }); 
  }

  function grabAll(names, onProgress, onDone) {
    var images = [];
    var parser=new DOMParser();
    names.forEach(function(name) {
      console.log('grab',name.name);
      $.get("https://connections.harvard.edu/search/pageNum/0/resultsPerPage/1?name="+name.search,function(data, error){
        var xmlDoc=parser.parseFromString(data,"text/html"); 
        images.push({
          name: name.name,
          code: $('#compressedUser tr',xmlDoc).first().html().replace('<td>','').replace('</td>','').replace('<a','<br><a')
        });
        onProgress(names, images);
        if (images.length === names.length) {
          onDone(names, images);
        }
      });
    })
  }

  function done(names, images) {  
    images = images.sort(function(a, b) {
      return a.name.localeCompare(b.name);
    });
    
    document.body.innerHTML = htmlCode;

    var $div = $('div');
    images.forEach(function(row) {
      $('<div class="block"/>').appendTo($div).html(row.code);
    });
  }

  $('<style>').appendTo('head').text(cssCode);
  $('<form id="teachlet"><b>Teachlet - Student Picture Extractor</b><br><textarea style="height:500px;width:300px" placeholder="Paste student names here (from sectioning tool)"></textarea><br><button type="submit" style="margin-top:10px">Generate</button><progress value="0" max="100"></progress></form>').appendTo('body').on('submit', function() {
    var names = $(this).find('textarea').val();
    names = toNames(names);
    var $progress = $(this).find('progress').attr('max', names.length);
    grabAll(names, function(names, images) {
      console.log('grabbed',name.name);
      $progress.val(images.length);
    }, done);
    return false;
  });
}

//inject code
var code = grab_pics.toString();
var css = document.getElementById('gallery').innerText.replace('\r\n',' ');
var hh = document.getElementById('gallerytext').innerHTML.replace('\r\n',' ');
code = code.replace('ENTER_HERE', css);
code = code.replace('ENTER_HTML', hh);
code = code.replace('\r\n', ' ').replace('  ',' ').replace('  ',' ').replace('  ',' ').replace('  ',' ');
document.getElementById('bookmarklet').href = 'javascript:(' + code +')()';

</script>

</body>
</html>

